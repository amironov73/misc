# LLM thunk

Простая DLL для вызова из `&uf(+8)`.

Записывает весь переданный ей текст в файл `llm_input.txt`, вызывает `llmcall.exe`, после чего возвращает АРМу содержимое файла `llm_output.txt`.

# Технические детали

Создать «самодостаточную» DLL под Windows, которая ссылается только на стандартные системные библиотеки `kernel32.dll`, `user32.dll`, `advapi32.lib` и `shell32.dll`, можно, если полностью отказаться от C-runtime (CRT) и взять на себя его обязанности.

Ключевые приёмы:

* отключить подключение библиотек по умолчанию (`/NODEFAULTLIB`) и сгенерировать собственную точку входа;

* выключить защиту стека `/GS`, генерацию манифеста и прочие функции CRT;

* не вызывать функций CRT — вместо них пользоваться Win32-API (`GlobalAlloc`, `lstrlenA`, `wsprintfA` и т.п.) либо реализовать минимальные аналоги (например `int _fltused = 0;`).

Исходный код DLL рассчитан на компилятор Microsoft Visual C из комплекта поставки Microsoft Visual Studio 2017 или новее. Работоспособность с другими компиляторами не проверялась.

Используемые ключи командной строки компилятора `cl`:

`/nologo`

* Скрывает стартовое информационное сообщение компилятора.

`/GS-`

* Отключение защиты стека SEH (Stack Guard).

`/Zl`

* Исключает стандартный заголовочный файл и библиотеки по умолчанию из процесса компиляции. Без этого ключа компилятор автоматически добавляет стандартные заголовки вроде `<windows.h>` и библиотеки вроде `kernel32.lib`. Когда используется ключ `/Zl`, вам придётся вручную включать всё необходимое.

`/Oi`

* Включает встроенные функции (inline). Компилятор попытается заменить вызов некоторых функций встроенным кодом.

`/TC`

* Указывает компилятору обрабатывать все исходники как файлы на языке Си (расширение .c) даже если расширение отличается.

`/LD`

* Генерирует динамически подключаемую библиотеку (DLL) вместо обычного исполняемого файла (EXE). Вместо функции входа `main()` должна быть указана точка входа для DLL, чаще всего это `DllMain`.

`/D_CRT_SECURE_NO_WARNINGS`

* Подавляет предупреждения о небезопасных функциях стандартной библиотеки C (например, `strcpy`, `sprintf` и др.).

`/machine:X86`

* Задает архитектуру, для которой генерируется код. Здесь задаётся архитектура `x86` (32-разрядная). 

`/DWIN32`

* Определяет макроопределение `_WIN32`, что делает доступным ряд особенностей и API-интерфейсов Windows, предназначенных специально для 32-разрядных приложений.

`/D_WINDOWS`

* Определяет макроопределение `_WINDOWS`, подразумевая использование библиотек и API Windows.

`/O2`

* Уровень максимальной оптимизации по скорости исполнения программы. Компилятор активно применяет различные методы оптимизации для повышения производительности исполняемого файла.

`/Ob2`

* Максимально разрешает встраивание функций (inlining). Чем больше уровень, тем агрессивнее применяются встроенные функции. Уровень 2 разрешает максимальное применение inline-функций.

`/DNDEBUG`

Определён символ `NDEBUG`, означающий, что приложение собирается в режиме релиза. Все утверждения (`assert()`) игнорируются, и конфигурация предназначена для продуктивной эксплуатации.

Далее следуют параметры линковщика (`/link`)

`/INCREMENTAL:NO`

* Отключает инкрементальную сборку. Инкрементальная сборка ускоряет создание больших бинарников путём частичных пересборок. Однако она увеличивает размер конечного файла и снижает стабильность. Отключение помогает избежать проблем стабильности и уменьшить итоговый размер.

`/ENTRY:DllMain`

* Устанавливает точку входа в создаваемый модуль как `DllMain`. Важно именно для динамических библиотек (DLL).

`/OUT:llmthunk.dll`

* Имя выходного файла — динамическая библиотека (DLL), названная `llmthunk.dll`.

`kernel32.lib user32.lib`

* Библиотеки импорта, которые будут использованы при создании финального бинарника. `kernel32.lib` — основной компонент ОС Windows, содержащий низкоуровневые API; `user32.lib` — библиотека GUI-функций.
