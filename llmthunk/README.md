# LLM thunk

Простая DLL для вызова из `&uf('+8')`.

Записывает весь переданный ей текст в файл `llm_input.txt`, вызывает `llmcall.exe`, после чего возвращает АРМу содержимое файла `llm_output.txt`.

# Технические детали

Создать «самодостаточную» DLL под Windows, которая ссылается только на стандартные системные библиотеки `kernel32.dll`, `user32.dll`, `advapi32.lib`, `shell32.dll` и `shlwapi.lib`, можно, если полностью отказаться от C-runtime (CRT) и взять на себя его обязанности.

Ключевые приёмы:

* отключить библиотеки по умолчанию (`/NODEFAULTLIB`) и сгенерировать собственную точку входа;

* выключить защиту стека `/GS`, генерацию манифеста и прочие функции CRT;

* не вызывать функций CRT — вместо них пользоваться Win32-API (`GlobalAlloc`, `lstrlenA`, `wsprintfA` и т.п.) либо реализовать минимальные аналоги (например `int _fltused = 0;`).

Исходный код DLL рассчитан на компилятор Microsoft Visual C из комплекта поставки Microsoft Visual Studio 2017 или новее. Работоспособность с другими компиляторами не проверялась.

Используемые ключи командной строки компилятора `cl`:

`/nologo`

* Скрывает стартовое информационное сообщение компилятора.

`/GS-`

* Отключение защиты стека SEH (Stack Guard).

`/Zl`

* Исключает стандартный заголовочный файл и библиотеки по умолчанию из процесса компиляции. Без этого ключа компилятор автоматически добавляет стандартные заголовки вроде `<windows.h>` и библиотеки вроде `kernel32.lib`. Когда используется ключ `/Zl`, вам придётся вручную включать всё необходимое.

`/TC`

* Указывает компилятору обрабатывать все исходники как файлы на языке Си (расширение .c) даже если расширение отличается.

`/LD`

* Генерирует динамически подключаемую библиотеку (DLL) вместо обычного исполняемого файла (EXE). Вместо функции входа `main()` должна быть указана точка входа для DLL, чаще всего это `DllMain`.

`/D_CRT_SECURE_NO_WARNINGS`

* Подавляет предупреждения о небезопасных функциях стандартной библиотеки C (например, `strcpy`, `sprintf` и др.).

`/machine:X86`

* Задает архитектуру, для которой генерируется код. Здесь задаётся архитектура `x86` (32-разрядная). 

`/DWIN32`

* Определяет макроопределение `_WIN32`, что делает доступным ряд особенностей и API-интерфейсов Windows, предназначенных специально для 32-разрядных приложений.

`/D_WINDOWS`

* Определяет макроопределение `_WINDOWS`, подразумевая использование библиотек и API Windows.

`/O2`

* Уровень максимальной оптимизации по скорости исполнения программы. Компилятор активно применяет различные методы оптимизации для повышения производительности исполняемого файла.

`/Ob2`

* Максимально разрешает встраивание функций (inlining). Чем больше уровень, тем агрессивнее применяются встроенные функции. Уровень 2 разрешает максимальное применение inline-функций.

`/DNDEBUG`

Определён символ `NDEBUG`, означающий, что приложение собирается в режиме релиза. Все утверждения (`assert()`) игнорируются, и конфигурация предназначена для продуктивной эксплуатации.

Далее следуют параметры линковщика (`/link`)

`/INCREMENTAL:NO`

* Отключает инкрементальную сборку. Инкрементальная сборка ускоряет создание больших бинарников путём частичных пересборок. Однако она увеличивает размер конечного файла и снижает стабильность. Отключение помогает избежать проблем стабильности и уменьшить итоговый размер.

`/ENTRY:DllMain`

* Устанавливает точку входа в создаваемый модуль как `DllMain`. Важно именно для динамических библиотек (DLL).

`/OUT:llmthunk.dll`

* Имя выходного файла — динамическая библиотека (DLL), названная `llmthunk.dll`.

`kernel32.lib user32.lib ...`

* Библиотеки импорта, которые будут использованы при создании финального бинарника. `kernel32.lib` — основной компонент ОС Windows, содержащий низкоуровневые API; `user32.lib` — библиотека GUI-функций.

# Функции, предоставляемые стандартными DLL Windows 

## kernel32.dll

* `lstrlen` - Вычисление длины строки (исключая завершающий нулевой символ).

* `lstrcpy` - Копирование строки в буфер.

* `lstrcat` - Конкатенация строки.

* `lstrcmp` - Сравнение двух строк с учетом регистра символов.

* `lstrcmpi` - Сравнение двух строки без учета регистра символов.

* `lstrcpyn` - Копирование указанного количества символов строки.

**Работа с путями**

* `GetFullPathName` - Получает полный путь к файлу.

* `GetShortPathName` - Получает короткое имя пути (формат 8.3).

* `GetLongPathName` - Получает длинное имя пути.

* `GetTempPath` - Получает путь к временной папке.

* `GetTempFileName` - Создает уникальное имя временного файла.

* `GetCurrentDirectory` - Получает текущую рабочую папку.

* `SetCurrentDirectory` - Устанавливает текущую рабочую папку.

* `GetFinalPathNameByHandle` - Получает окончательный путь по дескриптору файла.

**Преобразование кодировок**

* `MultiByteToWideChar` - Преобразует многобайтовую строку в Unicode (UTF-16).

* `WideCharToMultiByte` - Преобразует Unicode строку в многобайтовую.

* `OemToChar` - Преобразует OEM строку в ANSI.

* `CharToOem` - Преобразует ANSI строку в OEM.

* `OemToCharBuff` - Преобразует OEM буфер в ANSI буфер.

* `CompareString` - Сравнивает строки с учетом локали.

**Форматирование и обработка сообщений**

* `FormatMessage` - Форматирует строку сообщения.

**Файлы конфигурации**

* `GetPrivateProfileString` - Читает строку из INI-файла.

* `GetProfileString` - Читает строку из `WIN.INI`.

* `WritePrivateProfileString` - Записывает строку в INI-файл.

* `WriteProfileString` - Записывает строку в WIN.INI.

## user32.dll

* `MessageBox` - Отображает окно с сообщением.

* `GetWindowText` - Получает текст заголовка окна.

* `SetWindowText` - Устанавливает текст заголовка окна.

* `GetDlgItemText` - Получает текст элемента диалога.

* `SetDlgItemText` - Устанавливает текст элемента диалога.

## shell32.dll и shlwapi.dll

* `PathCombine` - Объединяет два пути в один.

* `PathAddBackslash` - Добавляет обратную косую черту в конец пути.

* `PathRemoveBackslash` - Удаляет обратную косую черту с конца пути.

* `PathAppend` - Добавляет путь к существующему пути.

* `PathCanonicalizePathCanonicalize` - Упрощает путь, удаляя элементы навигации.

* `PathFileExists` - Проверяет существование файла или папки.

* `PathFindFileName` - Получает имя файла из пути.

* `PathFindExtension` - Получает расширение файла из пути.

* `PathRemoveExtension` - Удаляет расширение из пути.

* `PathRemoveFileSpec` - Удаляет имя файла и обратную косую черту с конца пути.

* `PathStripPath` - Удаляет путь, оставляя только имя файла.

* `PathIsDirectory` - Проверяет, является ли путь папкой.

* `PathIsRoot` - Проверяет, является ли путь корневым.

* `PathIsRelative` - Проверяет, является ли путь относительным.

* `PathIsUNC` - Проверяет, является ли путь UNC-путем.

* `PathCompactPath` - Сокращает путь для отображения в ограниченном пространстве.

* `PathCompactPathEx` - Сокращает путь до указанного количества символов.

* `PathBuildRoot` - Создает корневой путь из номера диска.

* `PathCommonPrefix` - Находит общий префикс двух путей.

* `SHGetLocalizedName` - Получает локализованное имя файла.

* `PathQuoteSpaces` - Заключает путь в кавычки при наличии пробелов.

* `PathUnquoteSpaces` - Удаляет кавычки из пути.
